#!/usr/bin/env python3
import re
import sys
import os
from pathlib import Path
from spellchecker import SpellChecker

# åˆå§‹åŒ–æ‹¼å†™æ£€æŸ¥å™¨ï¼ˆä»…è‹±è¯­ï¼‰
spell = SpellChecker(language='en')
spell.distance = 1  # å®¹é”™è·ç¦»

# å¯ä»¥æ·»åŠ è‡ªå®šä¹‰è¯æ±‡ï¼ˆä¸“ä¸šæœ¯è¯­ã€ç¼©å†™ç­‰ï¼‰
custom_words = [
    'github', 'tex', 'markdown', 'latex', 'bibliography',
    'algorithm', 'pseudocode', 'endwhile', 'endif', 
    'endfor', 'endfunction', 'endprocedure'
]
spell.word_frequency.load_words(custom_words)

def contains_chinese(text):
    """æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦"""
    return bool(re.search(r'[\u4e00-\u9fff]', text))

def extract_english_words(text):
    """æå–æ–‡æœ¬ä¸­çš„è‹±æ–‡å•è¯"""
    # åŒ¹é…è‹±æ–‡å•è¯ï¼ˆåŒ…æ‹¬å¸¦è¿å­—ç¬¦çš„ï¼‰
    words = re.findall(r'\b[a-zA-Z][a-zA-Z-]*\b', text)
    # è¿‡æ»¤æ‰å¤ªçŸ­çš„å•è¯ï¼ˆå¯é€‰ï¼‰
    return [word.lower() for word in words if len(word) > 2]

def check_file(file_path):
    """æ£€æŸ¥å•ä¸ªæ–‡ä»¶çš„æ‹¼å†™"""
    errors = []
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # å¦‚æœæ–‡ä»¶åŒ…å«ä¸­æ–‡ï¼Œè·³è¿‡æˆ–å¤„ç†è‹±æ–‡éƒ¨åˆ†
        if contains_chinese(content):
            # æå–è‹±æ–‡éƒ¨åˆ†è¿›è¡Œæ‹¼å†™æ£€æŸ¥
            english_words = extract_english_words(content)
            
            # æ‰¾å‡ºæ‹¼å†™é”™è¯¯çš„å•è¯
            misspelled = spell.unknown(english_words)
            
            if misspelled:
                # è·å–å»ºè®®çš„æ­£ç¡®æ‹¼å†™
                for word in misspelled:
                    suggestions = list(spell.candidates(word))[:3]
                    errors.append({
                        'word': word,
                        'suggestions': suggestions,
                        'file': file_path
                    })
        else:
            # çº¯è‹±æ–‡æ–‡ä»¶ï¼Œç›´æ¥æ£€æŸ¥
            lines = content.split('\n')
            for line_num, line in enumerate(lines, 1):
                words = extract_english_words(line)
                misspelled = spell.unknown(words)
                
                if misspelled:
                    for word in misspelled:
                        suggestions = list(spell.candidates(word))[:3]
                        errors.append({
                            'word': word,
                            'suggestions': suggestions,
                            'file': file_path,
                            'line': line_num,
                            'context': line.strip()[:100]  # æ˜¾ç¤ºä¸Šä¸‹æ–‡å‰100å­—ç¬¦
                        })
    
    except UnicodeDecodeError:
        print(f"Warning: Could not read {file_path} as UTF-8")
    except Exception as e:
        print(f"Error processing {file_path}: {e}")
    
    return errors

def main():
    # æ£€æŸ¥çš„æ–‡ä»¶æ‰©å±•å
    target_extensions = {'.tex', '.md'}
    
    # è¦å¿½ç•¥çš„ç›®å½•
    ignore_dirs = {'.git', '.github', 'node_modules', '__pycache__', 'build', 'dist'}
    
    # è¦å¿½ç•¥çš„æ–‡ä»¶æ¨¡å¼
    ignore_patterns = ['*.log', '*.aux', '*.pdf', '*.png', '*.jpg']
    
    all_errors = []
    
    # éå†æ‰€æœ‰æ–‡ä»¶
    for root, dirs, files in os.walk('.'):
        # è·³è¿‡å¿½ç•¥çš„ç›®å½•
        dirs[:] = [d for d in dirs if d not in ignore_dirs]
        
        for file in files:
            file_path = Path(root) / file
            
            # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            if file_path.suffix.lower() in target_extensions:
                # æ£€æŸ¥æ˜¯å¦åŒ¹é…å¿½ç•¥æ¨¡å¼
                skip = False
                for pattern in ignore_patterns:
                    if file_path.match(pattern):
                        skip = True
                        break
                
                if not skip:
                    errors = check_file(file_path)
                    all_errors.extend(errors)
    
    # ç”ŸæˆæŠ¥å‘Š
    if all_errors:
        print(f"\nâŒ Found {len(all_errors)} potential spelling errors:\n")
        
        with open('spellcheck_report.txt', 'w', encoding='utf-8') as report:
            for error in all_errors:
                line_info = f"Line {error.get('line', 'N/A')}: " if 'line' in error else ""
                message = f"â€¢ {error['file']} - {line_info}'{error['word']}'"
                if error['suggestions']:
                    message += f" (Suggestions: {', '.join(error['suggestions'])})"
                if 'context' in error:
                    message += f"\n  Context: {error['context']}"
                
                print(message)
                report.write(message + '\n')
        
        # ä¿å­˜æŠ¥å‘Šå¹¶è®¾ç½®é€€å‡ºç 
        print("\nğŸ“„ Spell check report saved to 'spellcheck_report.txt'")
        sys.exit(1)  # å¤±è´¥é€€å‡º
    else:
        print("âœ… No spelling errors found!")
        with open('spellcheck_report.txt', 'w', encoding='utf-8') as report:
            report.write("âœ… No spelling errors found!")
        sys.exit(0)  # æˆåŠŸé€€å‡º

if __name__ == '__main__':
    main()